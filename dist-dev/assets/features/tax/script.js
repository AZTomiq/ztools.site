const TAX_CONFIG={bhxh:{rate:.08,cap:468e5},bhyt:{rate:.015,cap:468e5},bhtn:{rate:.01},bhtnCaps:{1:992e5,2:882e5,3:772e5,4:69e6},bhxhCompany:{rate:.17,cap:468e5},bhnnCompany:{rate:.005,cap:468e5},bhytCompany:{rate:.03,cap:468e5},bhtnCompany:{rate:.01},personalDeduction:{old:11e6,new:155e5},dependentDeduction:{old:44e5,new:62e5},bracketsOld:[[5e6,.05],[1e7,.1],[18e6,.15],[32e6,.2],[52e6,.25],[8e7,.3],[1/0,.35]],bracketsNew:[[1e7,.05],[3e7,.15],[6e7,.25],[1e8,.3],[1/0,.35]]};let incomeType="gross",netScenario="keep-gross";const HISTORY_KEY="pit_calc_history",HISTORY_ENABLED_KEY="pit_calc_history_enabled",MAX_HISTORY=10;function isHistoryEnabled(){return"false"!==localStorage.getItem(HISTORY_ENABLED_KEY)}function setHistoryEnabled(e){localStorage.setItem(HISTORY_ENABLED_KEY,e?"true":"false"),renderHistory()}function getHistory(){try{return JSON.parse(localStorage.getItem(HISTORY_KEY))||[]}catch{return[]}}function saveToHistory(e){if(!isHistoryEnabled())return;const t=getHistory(),n={...e,timestamp:Date.now(),id:Date.now().toString(36)},o=t.filter(t=>!(t.income===e.income&&t.type===e.type&&t.dependents===e.dependents&&t.bonus===e.bonus));o.unshift(n),localStorage.setItem(HISTORY_KEY,JSON.stringify(o.slice(0,10))),renderHistory()}function loadFromHistory(e){const t=getHistory().find(t=>t.id===e);t&&(document.getElementById("incomeInput").value=parseInt(t.income,10).toLocaleString("vi-VN"),document.getElementById("dependents").value=t.dependents,document.getElementById("bonusMonths").value=t.bonus||0,document.getElementById("region").value=t.region,t.type&&["gross","net"].includes(t.type)&&(incomeType=t.type,document.querySelectorAll(".toggle-btn").forEach(e=>{e.classList.toggle("active",e.dataset.type===t.type)})),updateBhtnCapDisplay(),calculate())}function clearHistory(){localStorage.removeItem(HISTORY_KEY),renderHistory()}function confirmClearHistory(){confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠ t√≠nh thu·∫ø?")&&clearHistory()}function renderHistory(){const e=document.getElementById("historyList");if(!e)return;const t=isHistoryEnabled(),n=document.getElementById("historyEnabled");n&&(n.checked=t);const o=document.getElementById("historyPrivacy"),a=document.getElementById("historyWrapper"),l=document.getElementById("historyClearBtn");if(o&&(o.style.display=t?"block":"none"),a&&(a.style.display=t?"flex":"none"),!t)return void(e.innerHTML="");const r=getHistory();l&&(l.style.display=r.length>0?"block":"none"),0!==r.length?e.innerHTML=r.map(e=>{const t=parseInt(e.income,10).toLocaleString("vi-VN"),n="net"===e.type?"Net":"Gross",o=e.dependents>0?`, ${e.dependents} NPT`:"",a=e.bonus>0?`, +${e.bonus}th`:"";return`\n      <button class="history-item" onclick="loadFromHistory('${e.id}')">\n        <span class="history-value">${t}ƒë</span>\n        <span class="history-meta">${n}${o}${a}</span>\n      </button>\n    `}).join(""):e.innerHTML='<p class="history-empty">Ch∆∞a c√≥ l·ªãch s·ª≠</p>'}function calculateProgressiveTax(e,t){if(e<=0)return 0;let n=0,o=0;for(const[a,l]of t){const t=Math.min(e,a)-o;if(t<=0)break;n+=t*l,o=a}return n}function calculateTaxBreakdown(e,t){const n=[];let o=0;for(const[a,l]of t){const t=Math.min(e,a)-o,r=t>0?t*l:0;if(n.push({from:o,to:a===1/0?null:a,rate:l,taxable:Math.max(0,t),tax:r}),o=a,e<=a)break}return n}function calcInsurance(e,t,n){return Math.min(e,n)*t}function getRegion(){const e=document.getElementById("region");return e?parseInt(e.value,10):1}function getBhtnCap(){return TAX_CONFIG.bhtnCaps[getRegion()]}function calculatePIT(e,t){const n=TAX_CONFIG,o=getBhtnCap(),a=calcInsurance(e,n.bhxh.rate,n.bhxh.cap),l=calcInsurance(e,n.bhyt.rate,n.bhyt.cap),r=calcInsurance(e,n.bhtn.rate,o),c=a+l+r,s=e-c,d=n.personalDeduction.old+n.dependentDeduction.old*t,i=n.personalDeduction.new+n.dependentDeduction.new*t,u=Math.max(0,s-d),y=Math.max(0,s-i),h=calculateProgressiveTax(u,n.bracketsOld),m=calculateProgressiveTax(y,n.bracketsNew),g=calculateTaxBreakdown(u,n.bracketsOld),p=calculateTaxBreakdown(y,n.bracketsNew),f=Math.max(0,s-n.personalDeduction.old),b=Math.max(0,s-n.personalDeduction.new);return{grossIncome:e,dependents:t,bhxh:a,bhyt:l,bhtn:r,insurance:c,incomeAfterInsurance:s,deductionOld:d,deductionNew:i,taxableOld:u,taxableNew:y,taxOld:h,taxNew:m,breakdownOld:g,breakdownNew:p,taxSelfOnlyOld:calculateProgressiveTax(f,n.bracketsOld),taxSelfOnlyNew:calculateProgressiveTax(b,n.bracketsNew),taxSaved:h-m,netOld:e-c-h,netNew:e-c-m}}function calculateYearlyPIT(e,t,n){const o=TAX_CONFIG,a=getBhtnCap(),l=e*n,r=12*e+l,c=12*(calcInsurance(e,o.bhxh.rate,o.bhxh.cap)+calcInsurance(e,o.bhyt.rate,o.bhyt.cap)+calcInsurance(e,o.bhtn.rate,a)),s=r-c,d=12*(o.personalDeduction.old+o.dependentDeduction.old*t),i=12*(o.personalDeduction.new+o.dependentDeduction.new*t),u=Math.max(0,s-d),y=Math.max(0,s-i),h=calculateProgressiveTax(u,o.bracketsOld),m=calculateProgressiveTax(y,o.bracketsNew);return{yearlyGross:r,bonusGross:l,yearlyInsurance:c,yearlyIncomeAfterInsurance:s,yearlyDeductionOld:d,yearlyDeductionNew:i,yearlyTaxableOld:u,yearlyTaxableNew:y,yearlyTaxOld:h,yearlyTaxNew:m,yearlyNetOld:r-c-h,yearlyNetNew:r-c-m,yearlySaved:h-m}}function netToGross(e,t,n=!1){let o=e,a=2*e;for(let l=0;l<100;l++){const l=Math.floor((o+a)/2),r=calculatePIT(l,t),c=n?r.netNew:r.netOld;if(Math.abs(c-e)<1)return l;c<e?o=l:a=l}return Math.floor((o+a)/2)}function formatMoney(e){return Math.round(e).toLocaleString("vi-VN")+" ‚Ç´"}function calcCompanyInsuranceDetail(e){const t=TAX_CONFIG,n=getBhtnCap(),o=calcInsurance(e,t.bhxhCompany.rate,t.bhxhCompany.cap),a=calcInsurance(e,t.bhnnCompany.rate,t.bhnnCompany.cap),l=calcInsurance(e,t.bhytCompany.rate,t.bhytCompany.cap),r=calcInsurance(e,t.bhtnCompany.rate,n);return{bhxh:o,bhnn:a,bhyt:l,bhtn:r,total:o+a+l+r}}function renderNetAsGross(e,t){const n=calculatePIT(e,t),o=netToGross(e,t),a=calculatePIT(o,t),l=calcCompanyInsuranceDetail(e).total,r=e+l+n.taxOld,c=calcCompanyInsuranceDetail(o).total,s=o+c,d=s-r;let i=[{label:"Net th·ª±c nh·∫≠n",wrong:formatMoney(e),correct:formatMoney(e)},{label:"Gross ƒë·ªÉ t√≠nh thu·∫ø",wrong:formatMoney(e),correct:formatMoney(o),highlight:!0},{label:"Thu·∫ø TNCN (CT tr·∫£)",wrong:formatMoney(n.taxOld),correct:formatMoney(a.taxOld),highlight:!0},{label:"BH c√¥ng ty ƒë√≥ng (21.5%)",wrong:formatMoney(l),correct:formatMoney(c),info:!0},{label:"T·ªïng CT chi/th√°ng",wrong:formatMoney(r),correct:formatMoney(s)}].map(e=>`\n    <tr class="${e.info?"info-row":""} ${e.highlight?"diff-row":""}">\n      <td class="col-label">${e.label}</td>\n      <td class="col-old">${e.wrong}</td>\n      <td class="col-new">${e.correct}</td>\n    </tr>\n  `).join("");i+=`\n    <tr class="highlight-row">\n      <td class="col-label">üí∏ CT TI·∫æT KI·ªÜM (sai c√°ch)/TH√ÅNG</td>\n      <td colspan="2" class="saved-value" style="text-align: center;">\n        ${formatMoney(d)}\n      </td>\n    </tr>\n    <tr class="highlight-row">\n      <td class="col-label">üìÖ CT TI·∫æT KI·ªÜM (sai c√°ch)/NƒÇM</td>\n      <td colspan="2" class="saved-value" style="text-align: center;">\n        ${formatMoney(12*d)}\n      </td>\n    </tr>\n  `,document.getElementById("resultBody").innerHTML=i,document.querySelector("#resultSection .result-header h2").textContent="üìä So s√°nh: N‚ÜíG vs T√≠nh ƒë√∫ng",document.querySelector("#resultSection thead").innerHTML="\n    <tr>\n      <th>M·ª•c</th>\n      <th>N‚ÜíG (sai c√°ch)</th>\n      <th>T√≠nh ƒë√∫ng (Net)</th>\n    </tr>\n  ",document.getElementById("resultSection").classList.add("show"),document.getElementById("refundSection").classList.remove("show")}function parseMoneyInput(e){return parseInt(e.replace(/[^\d]/g,""),10)||0}function calculate(){const e=parseMoneyInput(document.getElementById("incomeInput").value),t=parseInt(document.getElementById("dependents").value,10)||0,n=getRegion(),o=parseInt(document.getElementById("bonusMonths").value,10)||0;if(e<=0)return void alert("Vui l√≤ng nh·∫≠p thu nh·∫≠p h·ª£p l·ªá");if(setUrlParams(e,incomeType,t,n,o),saveToHistory({income:e,type:incomeType,dependents:t,region:n,bonus:o}),"net-as-gross"===incomeType)return void renderNetAsGross(e,t);let a,l,r,c;const s=document.getElementById("resultNote");if("net"===incomeType)if("keep-gross"===netScenario)a=netToGross(e,t,!1),l=a,r=calculatePIT(a,t),c=r,s.innerHTML=`\n        <div class="note-info">\n          <strong>üìà K·ªãch b·∫£n: DN gi·ªØ nguy√™n Gross</strong><br>\n          N·∫øu DN kh√¥ng ƒëi·ªÅu ch·ªânh l∆∞∆°ng, NLƒê s·∫Ω ƒë∆∞·ª£c h∆∞·ªüng l·ª£i t·ª´ thu·∫ø gi·∫£m.<br>\n          Net 2026 cao h∆°n <strong>${formatMoney(r.netNew-r.netOld)}</strong>/th√°ng so v·ªõi 2025.\n        </div>\n      `,s.style.display="block";else{a=netToGross(e,t,!1),l=netToGross(e,t,!0),r=calculatePIT(a,t),c=calculatePIT(l,t);const n=a-l,o=calcCompanyInsuranceDetail(a),d=calcCompanyInsuranceDetail(l),i=a+o.total-(l+d.total);s.innerHTML=`\n        <div class="note-warning">\n          <strong>üíº K·ªãch b·∫£n: DN gi·ªØ nguy√™n Net</strong><br>\n          DN c√≥ th·ªÉ gi·∫£m Gross xu·ªëng ƒë·ªÉ gi·ªØ Net nh∆∞ c≈©, ti·∫øt ki·ªám <strong>${formatMoney(i)}</strong>/th√°ng chi ph√≠.<br>\n          <small>Gross gi·∫£m: ${formatMoney(n)} ¬∑ BH DN gi·∫£m: ${formatMoney(o.total-d.total)}</small>\n        </div>\n      `,s.style.display="block"}else a=e,l=e,r=calculatePIT(a,t),c=r,s.style.display="none";document.querySelector("#resultSection .result-header h2").textContent="üìä K·∫øt qu·∫£ t√≠nh thu·∫ø",document.querySelector("#resultSection thead").innerHTML="\n    <tr>\n      <th>M·ª•c</th>\n      <th>2025</th>\n      <th>2026</th>\n    </tr>\n  ";const d="keep-net"===netScenario&&"net"===incomeType,i=d?{old:a,new:l}:{old:r.grossIncome,new:r.grossIncome},u=d?{old:r.netOld,new:c.netNew}:{old:r.netOld,new:r.netNew},y=d?{old:r.taxOld,new:c.taxNew}:{old:r.taxOld,new:r.taxNew},h=[{label:"Thu nh·∫≠p Gross",old:formatMoney(i.old),new:formatMoney(i.new),highlight:i.old!==i.new},{label:"‚îî BHXH (8%)",old:formatMoney(r.bhxh),new:formatMoney(d?c.bhxh:r.bhxh),info:!0},{label:"‚îî BHYT (1.5%)",old:formatMoney(r.bhyt),new:formatMoney(d?c.bhyt:r.bhyt),info:!0},{label:"‚îî BHTN (1%)",old:formatMoney(r.bhtn),new:formatMoney(d?c.bhtn:r.bhtn),info:!0},{label:"T·ªïng BH b·∫Øt bu·ªôc (10.5%)",old:formatMoney(r.insurance),new:formatMoney(d?c.insurance:r.insurance)},{label:"Thu nh·∫≠p ch·ªãu thu·∫ø",old:formatMoney(r.incomeAfterInsurance),new:formatMoney(d?c.incomeAfterInsurance:r.incomeAfterInsurance)},{label:"‚îî Gi·∫£m tr·ª´ b·∫£n th√¢n",old:formatMoney(TAX_CONFIG.personalDeduction.old),new:formatMoney(TAX_CONFIG.personalDeduction.new),info:!0},{label:`‚îî Gi·∫£m tr·ª´ NPT (√ó${t})`,old:formatMoney(TAX_CONFIG.dependentDeduction.old*t),new:formatMoney(TAX_CONFIG.dependentDeduction.new*t),info:!0},{label:"T·ªïng gi·∫£m tr·ª´",old:formatMoney(r.deductionOld),new:formatMoney(d?c.deductionNew:r.deductionNew)},{label:"Thu nh·∫≠p t√≠nh thu·∫ø",old:formatMoney(r.taxableOld),new:formatMoney(d?c.taxableNew:r.taxableNew)},{label:"Thu·∫ø TNCN ph·∫£i n·ªôp",old:formatMoney(y.old),new:formatMoney(y.new)},{label:"Thu nh·∫≠p NET",old:formatMoney(u.old),new:formatMoney(u.new),highlight:d}],m=y.old-y.new;let g=h.map(e=>`\n    <tr class="${e.info?"info-row":""} ${e.highlight?"diff-row":""}">\n      <td class="col-label">${e.label}</td>\n      <td class="col-old">${e.old}</td>\n      <td class="col-new">${e.new}</td>\n    </tr>\n  `).join("");g+=`\n    <tr class="highlight-row">\n      <td class="col-label">üí∞ TI·ªÄN THU·∫æ GI·∫¢M/TH√ÅNG</td>\n      <td colspan="2" class="saved-value" style="text-align: center;">\n        ${m>=0?"+":""}${formatMoney(m)}\n      </td>\n    </tr>\n    <tr class="highlight-row">\n      <td class="col-label">üìÖ TI·ªÄN THU·∫æ GI·∫¢M/NƒÇM</td>\n      <td colspan="2" class="saved-value" style="text-align: center;">\n        ${m>=0?"+":""}${formatMoney(12*m)}\n      </td>\n    </tr>\n  `,document.getElementById("resultBody").innerHTML=g;const p=12*(r.taxSelfOnlyOld-r.taxOld),f=12*(r.taxSelfOnlyNew-r.taxNew);document.getElementById("refundBody").innerHTML=`\n    <tr>\n      <td class="col-label">Thu·∫ø kh·∫•u tr·ª´/th√°ng (ch·ªâ tr·ª´ b·∫£n th√¢n)</td>\n      <td class="col-old">${formatMoney(r.taxSelfOnlyOld)}</td>\n      <td class="col-new">${formatMoney(r.taxSelfOnlyNew)}</td>\n    </tr>\n    <tr>\n      <td class="col-label">Thu·∫ø kh·∫•u tr·ª´ c·∫£ nƒÉm</td>\n      <td class="col-old">${formatMoney(12*r.taxSelfOnlyOld)}</td>\n      <td class="col-new">${formatMoney(12*r.taxSelfOnlyNew)}</td>\n    </tr>\n    <tr>\n      <td class="col-label">Thu·∫ø th·ª±c t·∫ø (c√≥ NPT √ó${r.dependents})</td>\n      <td class="col-old">${formatMoney(12*r.taxOld)}</td>\n      <td class="col-new">${formatMoney(12*r.taxNew)}</td>\n    </tr>\n    <tr class="highlight-row refund-row">\n      <td class="col-label">üîÑ HO√ÄN THU·∫æ (nh·ªù NPT)</td>\n      <td class="saved-value">${formatMoney(p)}</td>\n      <td class="saved-value">${formatMoney(f)}</td>\n    </tr>\n  `;const b=(e,t)=>{const n=t?TAX_CONFIG.bracketsNew:TAX_CONFIG.bracketsOld;return n.map((t,o)=>{const a=e[o]||{tax:0,taxable:0},l=0===o?"ƒê·∫øn":`Tr√™n ${formatMoney(n[o-1][0]).replace(" ‚Ç´","")} ƒë·∫øn`,r=t[0]===1/0?"":` ${formatMoney(t[0]).replace(" ‚Ç´","")}`,c=t[0]===1/0?`Tr√™n ${formatMoney(n[o-1][0]).replace(" ‚Ç´","")}`:`${l}${r}`;return`\n        <tr class="${a.tax>0?"has-tax":"no-tax"}">\n          <td>${c}</td>\n          <td>${formatMoney(a.taxable)}</td>\n          <td>${Math.round(100*t[1])}%</td>\n          <td>${formatMoney(a.tax)}</td>\n        </tr>\n      `}).join("")};document.getElementById("breakdownOldBody").innerHTML=b(r.breakdownOld,!1),document.getElementById("breakdownNewBody").innerHTML=b(r.breakdownNew,!0);const w=calcCompanyInsuranceDetail(r.grossIncome),T=r.grossIncome+w.total;if(document.getElementById("employerBody").innerHTML=`\n    <tr>\n      <td class="col-label">L∆∞∆°ng GROSS</td>\n      <td class="col-new">${formatMoney(r.grossIncome)}</td>\n    </tr>\n    <tr class="info-row">\n      <td class="col-label">‚îî BHXH (17%)</td>\n      <td>${formatMoney(w.bhxh)}</td>\n    </tr>\n    <tr class="info-row">\n      <td class="col-label">‚îî BH tai n·∫°n Lƒê - B·ªánh ngh·ªÅ nghi·ªáp (0.5%)</td>\n      <td>${formatMoney(w.bhnn)}</td>\n    </tr>\n    <tr class="info-row">\n      <td class="col-label">‚îî BHYT (3%)</td>\n      <td>${formatMoney(w.bhyt)}</td>\n    </tr>\n    <tr class="info-row">\n      <td class="col-label">‚îî BHTN (1%)</td>\n      <td>${formatMoney(w.bhtn)}</td>\n    </tr>\n    <tr>\n      <td class="col-label">T·ªïng BH doanh nghi·ªáp (21.5%)</td>\n      <td class="col-new">${formatMoney(w.total)}</td>\n    </tr>\n    <tr class="highlight-row">\n      <td class="col-label">üíº T·ªîNG CHI PH√ç DN/TH√ÅNG</td>\n      <td class="saved-value">${formatMoney(T)}</td>\n    </tr>\n    <tr class="highlight-row">\n      <td class="col-label">üìÖ T·ªîNG CHI PH√ç DN/NƒÇM</td>\n      <td class="saved-value">${formatMoney(12*T)}</td>\n    </tr>\n  `,o>0){const e=calculateYearlyPIT(grossIncome,t,o);document.getElementById("yearlyBody").innerHTML=`\n      <tr>\n        <td class="col-label">L∆∞∆°ng 12 th√°ng</td>\n        <td class="col-old">${formatMoney(12*grossIncome)}</td>\n        <td class="col-new">${formatMoney(12*grossIncome)}</td>\n      </tr>\n      <tr>\n        <td class="col-label">Bonus (${o} th√°ng l∆∞∆°ng)</td>\n        <td class="col-old">${formatMoney(e.bonusGross)}</td>\n        <td class="col-new">${formatMoney(e.bonusGross)}</td>\n      </tr>\n      <tr>\n        <td class="col-label">T·ªïng thu nh·∫≠p Gross/nƒÉm</td>\n        <td class="col-old">${formatMoney(e.yearlyGross)}</td>\n        <td class="col-new">${formatMoney(e.yearlyGross)}</td>\n      </tr>\n      <tr class="info-row">\n        <td class="col-label">‚îî T·ªïng BH b·∫Øt bu·ªôc/nƒÉm</td>\n        <td>${formatMoney(e.yearlyInsurance)}</td>\n        <td>${formatMoney(e.yearlyInsurance)}</td>\n      </tr>\n      <tr class="info-row">\n        <td class="col-label">‚îî T·ªïng gi·∫£m tr·ª´/nƒÉm</td>\n        <td>${formatMoney(e.yearlyDeductionOld)}</td>\n        <td>${formatMoney(e.yearlyDeductionNew)}</td>\n      </tr>\n      <tr>\n        <td class="col-label">Thu nh·∫≠p t√≠nh thu·∫ø/nƒÉm</td>\n        <td class="col-old">${formatMoney(e.yearlyTaxableOld)}</td>\n        <td class="col-new">${formatMoney(e.yearlyTaxableNew)}</td>\n      </tr>\n      <tr>\n        <td class="col-label">Thu·∫ø TNCN c·∫£ nƒÉm</td>\n        <td class="col-old">${formatMoney(e.yearlyTaxOld)}</td>\n        <td class="col-new">${formatMoney(e.yearlyTaxNew)}</td>\n      </tr>\n      <tr>\n        <td class="col-label">Thu nh·∫≠p NET c·∫£ nƒÉm</td>\n        <td class="col-old">${formatMoney(e.yearlyNetOld)}</td>\n        <td class="col-new">${formatMoney(e.yearlyNetNew)}</td>\n      </tr>\n      <tr class="highlight-row">\n        <td class="col-label">üí∞ TI·ªÄN THU·∫æ GI·∫¢M/NƒÇM</td>\n        <td colspan="2" class="saved-value" style="text-align: center;">\n          ${e.yearlySaved>=0?"+":""}${formatMoney(e.yearlySaved)}\n        </td>\n      </tr>\n    `,document.getElementById("yearlySection").classList.add("show")}else document.getElementById("yearlySection").classList.remove("show");document.getElementById("employerSection").classList.add("show"),document.getElementById("breakdownSection").classList.add("show"),document.getElementById("refundSection").classList.add("show"),document.getElementById("resultSection").classList.add("show")}function updateBhtnCapDisplay(){const e=getRegion(),t=(TAX_CONFIG.bhtnCaps[e]/1e6).toFixed(1)+"M";document.getElementById("bhtnCapDisplay").textContent=t}function toggleRegionNote(){document.getElementById("regionModal").classList.toggle("show")}function getUrlParams(){const e=new URLSearchParams(window.location.search);return{income:e.get("income"),type:e.get("type")||"gross",dependents:e.get("dep"),region:e.get("region"),bonus:e.get("bonus")}}function setUrlParams(e,t,n,o,a){const l=new URLSearchParams;l.set("income",e),l.set("type",t),l.set("dep",n),l.set("region",o),a>0&&l.set("bonus",a);const r=`${window.location.pathname}?${l.toString()}`;window.history.replaceState({},"",r)}function copyShareUrl(){navigator.clipboard.writeText(window.location.href).then(()=>{const e=document.getElementById("shareBtn"),t=e.textContent;e.textContent="‚úì ƒê√£ copy!",e.classList.add("copied"),setTimeout(()=>{e.textContent=t,e.classList.remove("copied")},2e3)})}async function exportAsImage(){if(document.getElementById("resultSection").classList.contains("show"))try{const e=document.createElement("div");e.style.cssText="background: #0f172a; padding: 20px; width: fit-content;";["resultSection","breakdownSection","yearlySection"].forEach(t=>{const n=document.getElementById(t);n&&n.classList.contains("show")&&e.appendChild(n.cloneNode(!0))}),document.body.appendChild(e);const t=await html2canvas(e,{backgroundColor:"#0f172a",scale:2});document.body.removeChild(e);const n=document.createElement("a");n.download=`thue-tncn-${(new Date).toISOString().slice(0,10)}.png`,n.href=t.toDataURL("image/png"),n.click()}catch(e){console.error("Export failed:",e),alert("Xu·∫•t ·∫£nh th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.")}else alert("Vui l√≤ng t√≠nh thu·∫ø tr∆∞·ªõc khi xu·∫•t ·∫£nh")}function initFromUrl(){const e=getUrlParams();if(e.income){if(document.getElementById("incomeInput").value=parseInt(e.income,10).toLocaleString("vi-VN"),e.type&&["gross","net"].includes(e.type)){incomeType=e.type,document.querySelectorAll(".toggle-btn").forEach(t=>{t.classList.toggle("active",t.dataset.type===e.type)});const t={gross:"Thu nh·∫≠p Gross (VNƒê/th√°ng)",net:"Thu nh·∫≠p Net (VNƒê/th√°ng)"};document.getElementById("incomeLabel").textContent=t[e.type]}e.dependents&&(document.getElementById("dependents").value=e.dependents),e.region&&(document.getElementById("region").value=e.region,updateBhtnCapDisplay()),e.bonus&&(document.getElementById("bonusMonths").value=e.bonus),setTimeout(calculate,100)}}function switchTab(e){document.querySelectorAll(".tab-btn").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),document.querySelectorAll(".tab-panel").forEach(t=>{t.classList.toggle("active",t.id===`tab-${e}`)})}function compareMultiple(){const e=document.getElementById("compareInput").value,t=parseInt(document.getElementById("compareDependents").value,10)||0,n=e.split(/[;,]/).map(e=>parseInt(e.replace(/[^\d]/g,""),10)).filter(e=>e>0).slice(0,5);if(n.length<2)return void alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t 2 m·ª©c l∆∞∆°ng ƒë·ªÉ so s√°nh");renderCompareTable(n.map(e=>({gross:e,...calculatePIT(e,t)})),t)}function renderCompareTable(e,t){const n=`\n    <tr>\n      <th>M·ª•c</th>\n      ${e.map(e=>`<th>${formatMoney(e.gross).replace(" ‚Ç´","")}</th>`).join("")}\n    </tr>\n  `;document.getElementById("compareHead").innerHTML=n;let o=[{label:"Thu nh·∫≠p Gross",key:"grossIncome"},{label:"T·ªïng BH (10.5%)",key:"insurance"},{label:"Gi·∫£m tr·ª´ b·∫£n th√¢n",getValue:()=>TAX_CONFIG.personalDeduction.new},{label:`Gi·∫£m tr·ª´ NPT (√ó${t})`,getValue:()=>TAX_CONFIG.dependentDeduction.new*t},{label:"Thu nh·∫≠p t√≠nh thu·∫ø",key:"taxableNew"},{label:"Thu·∫ø TNCN (2026)",key:"taxNew",highlight:!0},{label:"Thu nh·∫≠p NET",key:"netNew",highlight:!0}].map(t=>{const n=e.map(e=>{const n=t.key?e[t.key]:t.getValue(e);return`<td class="${t.highlight?"col-new":""}">${formatMoney(n)}</td>`}).join("");return`\n      <tr class="${t.highlight?"highlight-row":""}">\n        <td class="col-label">${t.label}</td>\n        ${n}\n      </tr>\n    `}).join("");const a=e[0].netNew;o+=`\n    <tr class="highlight-row">\n      <td class="col-label">üí∞ Ch√™nh l·ªách NET</td>\n      ${e.map((e,t)=>{if(0===t)return"<td>‚Äî</td>";const n=e.netNew-a;return`<td class="saved-value">${n>=0?"+":""}${formatMoney(n)}</td>`}).join("")}\n    </tr>\n  `,document.getElementById("compareBody2").innerHTML=o,document.getElementById("compareSection").classList.add("show"),document.getElementById("compareSection").scrollIntoView({behavior:"smooth",block:"start"})}document.querySelectorAll(".toggle-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".toggle-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active"),incomeType=this.dataset.type;document.getElementById("incomeLabel").textContent={gross:"Thu nh·∫≠p Gross (VNƒê/th√°ng)",net:"Thu nh·∫≠p Net (VNƒê/th√°ng)","net-as-gross":"Net l√†m Gross (VNƒê/th√°ng)"}[incomeType];const e=document.getElementById("scenarioToggle");e&&(e.style.display="net"===incomeType?"flex":"none")})}),document.querySelectorAll(".scenario-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".scenario-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active"),netScenario=this.dataset.scenario,document.getElementById("resultSection").classList.contains("show")&&calculate()})}),document.getElementById("incomeInput").addEventListener("input",function(){const e=this.value.replace(/[^\d]/g,"");e&&(this.value=parseInt(e,10).toLocaleString("vi-VN"))}),document.getElementById("compareInput").addEventListener("input",function(){const e=this.value;if(!e||e.endsWith(";")||e.endsWith(",")||e.endsWith(" "))return;const t=e.split(/\s*[;,]\s*/),n=t[t.length-1],o=t.slice(0,-1).map(e=>{const t=parseInt(e.replace(/[^\d]/g,""),10);return isNaN(t)?"":t.toLocaleString("vi-VN")}).filter(e=>e),a=n.replace(/[^\d]/g,"");a&&o.push(parseInt(a,10).toLocaleString("vi-VN")),o.length>0&&(this.value=o.join(" ; "))}),document.querySelectorAll("input").forEach(e=>{e.addEventListener("keypress",e=>{"Enter"===e.key&&calculate()})}),document.getElementById("region").addEventListener("change",updateBhtnCapDisplay),updateBhtnCapDisplay(),document.getElementById("regionModal").addEventListener("click",function(e){e.target===this&&this.classList.remove("show")}),initFromUrl(),window.calculate=calculate,window.toggleRegionNote=toggleRegionNote,window.copyShareUrl=copyShareUrl,window.switchTab=switchTab,window.compareMultiple=compareMultiple,window.loadFromHistory=loadFromHistory,window.setHistoryEnabled=setHistoryEnabled,window.clearHistory=clearHistory,window.confirmClearHistory=confirmClearHistory,window.exportAsImage=exportAsImage,document.addEventListener("DOMContentLoaded",renderHistory);