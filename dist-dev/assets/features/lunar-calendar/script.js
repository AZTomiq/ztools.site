const CAN=["Giáp","Ất","Bính","Đinh","Mậu","Kỷ","Canh","Tân","Nhâm","Quý"],CHI=["Tý","Sửu","Dần","Mão","Thìn","Tị","Ngọ","Mùi","Thân","Dậu","Tuất","Hợi"],ZODIAC_ANIMALS=["Chuột","Trâu","Hổ","Mèo","Rồng","Rắn","Ngựa","Dê","Khỉ","Gà","Chó","Lợn"],TIMEZONE_OFFSET=7;function jdFromDate(e,t,n){const a=Math.floor((14-t)/12),o=n+4800-a,r=t+12*a-3;let d=e+Math.floor((153*r+2)/5)+365*o+Math.floor(o/4)-Math.floor(o/100)+Math.floor(o/400)-32045;return d<2299161&&(d=e+Math.floor((153*r+2)/5)+365*o+Math.floor(o/4)-32083),d}function jdToDate(e){let t,n,a,o,r,d,u,l,c;return e>2299160?(t=e+32044,n=Math.floor((4*t+3)/146097),a=t-Math.floor(146097*n/4)):(n=0,a=e+32082),o=Math.floor((4*a+3)/1461),r=a-Math.floor(1461*o/4),d=Math.floor((5*r+2)/153),u=r-Math.floor((153*d+2)/5)+1,l=d+3-12*Math.floor(d/10),c=100*n+o-4800+Math.floor(d/10),[u,l,c]}function getNewMoonDay(e,t){const n=e/1236.85,a=n*n,o=a*n,r=Math.PI/180;let d=2415020.75933+29.53058868*e+1178e-7*a-155e-9*o;d+=33e-5*Math.sin((166.56+132.87*n-.009173*a)*r);const u=359.2242+29.10535608*e-333e-7*a-347e-8*o,l=306.0253+385.81691806*e+.0107306*a+1236e-8*o,c=21.2964+390.67050646*e-.0016528*a-239e-8*o;let i,h=(.1734-393e-6*n)*Math.sin(u*r)+.0021*Math.sin(2*r*u);h=h-.4068*Math.sin(l*r)+.0161*Math.sin(2*r*l),h-=4e-4*Math.sin(3*r*l),h=h+.0104*Math.sin(2*r*c)-.0051*Math.sin(r*(u+l)),h=h-.0074*Math.sin(r*(u-l))+4e-4*Math.sin(r*(2*c+u)),h=h-4e-4*Math.sin(r*(2*c-u))-6e-4*Math.sin(r*(2*c+l)),h=h+.001*Math.sin(r*(2*c-l))+5e-4*Math.sin(r*(2*l+u)),i=n<-11?.001+839e-6*n+2261e-7*a-845e-8*o-81e-9*n*o:265e-6*n-278e-6+262e-6*a;const s=d+h-i;return Math.floor(s+.5+t/24)}function getSunLongitude(e,t){const n=(e-2451545.5-t/24)/36525,a=n*n,o=Math.PI/180,r=357.5291+35999.0503*n-1559e-7*a-48e-8*n*a,d=280.46645+36000.76983*n+3032e-7*a;let u=(1.9146-.004817*n-14e-6*a)*Math.sin(o*r);u=u+(.019993-101e-6*n)*Math.sin(2*o*r)+29e-5*Math.sin(3*o*r);let l=d+u;return l*=o,l-=2*Math.PI*Math.floor(l/(2*Math.PI)),Math.floor(l/Math.PI*6+1e-9)}function getLunarMonth11(e,t){const n=jdFromDate(31,12,e)-2415021,a=Math.floor(n/29.530588853);let o=getNewMoonDay(a,t);return getSunLongitude(o,t)>=9&&(o=getNewMoonDay(a-1,t)),o}function getLeapMonthOffset(e,t){const n=Math.floor((e-2415021.076998695)/29.530588853+.5);let a=0,o=1,r=getSunLongitude(getNewMoonDay(n+o,t),t);do{a=r,o++,r=getSunLongitude(getNewMoonDay(n+o,t),t)}while(r!=a&&o<14);return o-1}function convertSolar2Lunar(e,t,n,a=7){const o=jdFromDate(e,t,n),r=Math.floor((o-2415021.076998695)/29.530588853);let d=getNewMoonDay(r+1,a);d>o&&(d=getNewMoonDay(r,a));let u,l=getLunarMonth11(n,a),c=l;l>=d?(u=n,l=getLunarMonth11(n-1,a)):(u=n+1,c=getLunarMonth11(n+1,a));const i=o-d+1,h=Math.floor((d-l)/29.53+.5);let s=0,g=h+11;if(c-l>365){const e=getLeapMonthOffset(l,a);h>=e&&(g=h+10,h==e&&(s=1))}return g>12&&(g-=12),g>=11&&h<4&&(u-=1),[i,g,u,s]}function convertLunar2Solar(e,t,n,a,o=7){let r,d;t<11?(r=getLunarMonth11(n-1,o),d=getLunarMonth11(n,o)):(r=getLunarMonth11(n,o),d=getLunarMonth11(n+1,o));const u=Math.floor(.5+(r-2415021.076998695)/29.530588853);let l=t-11;if(l<0&&(l+=12),d-r>365){const e=getLeapMonthOffset(r,o);if(0!=a&&t+1!=e)return[0,0,0];(0!=a||l>=e)&&(l+=1)}return jdToDate(getNewMoonDay(u+l,o)+e-1)}function getYearCanChi(e){return`${CAN[(e+6)%10]} ${CHI[(e+8)%12]}`}function getMonthCanChi(e,t){return`${CAN[(12*t+e+3)%10]} ${CHI[(e+1)%12]}`}function getDayCanChi(e,t,n){const a=jdFromDate(e,t,n);return`${CAN[(a+9)%10]} ${CHI[(a+1)%12]}`}function getZodiacAnimal(e){return ZODIAC_ANIMALS[(e+8)%12]}function getGoodHours(e){return{0:[0,1,3,6,8,9],1:[2,3,5,8,10,11],2:[0,1,4,5,7,10],3:[0,2,3,6,7,9],4:[2,4,5,8,9,11],5:[1,4,6,7,10,11],6:[0,1,3,6,8,9],7:[2,3,5,8,10,11],8:[0,1,4,5,7,10],9:[0,2,3,6,7,9],10:[2,4,5,8,9,11],11:[1,4,6,7,10,11]}[(e+1)%12]||[]}function formatDate(e,t,n){return`${String(e).padStart(2,"0")}/${String(t).padStart(2,"0")}/${n}`}function formatLunarDate(e,t,n,a=!1){const o=a?" (nhuận)":"";return`${String(e).padStart(2,"0")}/${String(t).padStart(2,"0")}${o}/${n}`}function handleDateConversion(){const e=document.getElementById("solar-date-input");if(!e||!e.value)return;const[t,n,a]=e.value.split("-").map(Number);updateMainCalendar(new Date(t,n-1,a))}function handleLunarConversion(){const e=parseInt(document.getElementById("lunar-day-input").value),t=parseInt(document.getElementById("lunar-month-input").value),n=parseInt(document.getElementById("lunar-year-input").value),a=document.getElementById("lunar-leap-input").checked?1:0;if(!e||!t||!n)return;const[o,r,d]=convertLunar2Solar(e,t,n,a);o>0&&updateMainCalendar(new Date(d,r-1,o))}function toggleInputMode(){const e=document.getElementById("solar-input-container"),t=document.getElementById("lunar-input-container"),n=document.getElementById("current-mode-label");if("none"!==e.style.display){e.style.display="none",t.style.display="flex",n&&(n.textContent="Âm lịch");const[a,o,r,d]=convertSolar2Lunar(currentSelectedDate.getDate(),currentSelectedDate.getMonth()+1,currentSelectedDate.getFullYear());document.getElementById("lunar-day-input").value=a,document.getElementById("lunar-month-input").value=o,document.getElementById("lunar-year-input").value=r,document.getElementById("lunar-leap-input").checked=!!d}else e.style.display="block",t.style.display="none",n&&(n.textContent="Dương lịch")}function initLunarInputs(){const e=document.getElementById("lunar-day-input"),t=document.getElementById("lunar-month-input");if(e)for(let t=1;t<=30;t++){const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)}if(t)for(let e=1;e<=12;e++){const n=document.createElement("option");n.value=e,n.textContent=e,t.appendChild(n)}}let currentSelectedDate=new Date;function updateMainCalendar(e){currentSelectedDate=new Date(e);const t=currentSelectedDate.getDate(),n=currentSelectedDate.getMonth()+1,a=currentSelectedDate.getFullYear();displayTodayLunar(t,n,a);const o=document.getElementById("solar-date-input");o&&(o.value=`${a}-${String(n).padStart(2,"0")}-${String(t).padStart(2,"0")}`);currentViewMonth=n,currentViewYear=a,renderMonthView(currentViewMonth,currentViewYear)}function displayTodayLunar(e,t,n){const[a,o,r,d]=convertSolar2Lunar(e,t,n),u="vi"===(document.documentElement.lang||"vi"),l=u?["Chủ Nhật","Thứ Hai","Thứ Ba","Thứ Tư","Thứ Năm","Thứ Sáu","Thứ Bảy"]:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],c=u?["Tháng 1","Tháng 2","Tháng 3","Tháng 4","Tháng 5","Tháng 6","Tháng 7","Tháng 8","Tháng 9","Tháng 10","Tháng 11","Tháng 12"]:["January","February","March","April","May","June","July","August","September","October","November","December"],i=new Date(n,t-1,e),h=l[i.getDay()],s=c[t-1],g=document.getElementById("today-solar-day"),m=document.getElementById("today-solar-month"),y=document.getElementById("today-solar-year"),M=document.getElementById("today-solar-weekday"),p=document.getElementById("today-lunar-day-month"),D=document.getElementById("today-year-canchi"),f=document.getElementById("today-month-canchi"),C=document.getElementById("today-day-canchi"),E=document.getElementById("today-zodiac");if(g&&(g.textContent=e,0===i.getDay()?g.classList.add("is-sunday"):g.classList.remove("is-sunday")),m&&(m.textContent=s),y&&(y.textContent=n),M&&(M.textContent=h),p){const e=d?u?" (Nhuận)":" (Leap)":"";p.textContent=`${String(a).padStart(2,"0")}/${String(o).padStart(2,"0")}${e}`}D&&(D.textContent=getYearCanChi(r)),f&&(f.textContent=getMonthCanChi(o,r)),C&&(C.textContent=getDayCanChi(e,t,n)),E&&(E.textContent=getZodiacAnimal(r)),displayGoodHours(e,t,n)}function displayGoodHours(e,t,n){const a=getGoodHours(jdFromDate(e,t,n)),o=document.getElementById("good-hours-list");if(o){o.innerHTML="";for(let e=0;e<12;e++){const t=a.includes(e),n=document.createElement("div");n.className="hour-item "+(t?"good":"bad"),n.innerHTML=`\n      <span class="hour-chi">${CHI[e]}</span>\n      <span class="hour-status">${t?"✓":"✗"}</span>\n    `,o.appendChild(n)}}}function goToPrevDay(){const e=new Date(currentSelectedDate);e.setDate(e.getDate()-1),updateMainCalendar(e)}function goToNextDay(){const e=new Date(currentSelectedDate);e.setDate(e.getDate()+1),updateMainCalendar(e)}function handleDateConversion(){const e=document.getElementById("solar-date-input");if(!e||!e.value)return;const[t,n,a]=e.value.split("-").map(Number),o=new Date(t,n-1,a);currentSelectedDate=o,displayTodayLunar(a,n,t)}let currentViewMonth=(new Date).getMonth()+1,currentViewYear=(new Date).getFullYear();function renderMonthView(e,t){const n=document.getElementById("calendar-grid"),a=document.getElementById("current-month-year");if(!n)return;const o=["January","February","March","April","May","June","July","August","September","October","November","December"];a&&(a.textContent=`${o[e-1]} ${t}`),n.innerHTML="";["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(e=>{const t=document.createElement("div");t.className="calendar-header",t.textContent=e,n.appendChild(t)});const r=new Date(t,e-1,1).getDay(),d=new Date(t,e,0).getDate(),u=new Date(t,e-1,0).getDate(),l=new Date,c=e===l.getMonth()+1&&t===l.getFullYear(),i=l.getDate();for(let a=r-1;a>=0;a--){addCalendarDay(n,u-a,1===e?12:e-1,1===e?t-1:t,!0)}for(let a=1;a<=d;a++){addCalendarDay(n,a,e,t,!1,c&&a===i)}const h=n.children.length-7,s=7*Math.ceil(h/7)-h,g=12===e?1:e+1,m=12===e?t+1:t;for(let e=1;e<=s;e++)addCalendarDay(n,e,g,m,!0)}function addCalendarDay(e,t,n,a,o=!1,r=!1){const d=document.createElement("div");d.className="calendar-day",o&&d.classList.add("other-month"),r&&d.classList.add("today");const[u,l,c,i]=convertSolar2Lunar(t,n,a),h=document.createElement("div");h.className="solar-date",h.textContent=t;const s=document.createElement("div");s.className="lunar-date",s.textContent=`${u}/${l}`,d.appendChild(h),d.appendChild(s);!o&&t===currentSelectedDate.getDate()&&n===currentSelectedDate.getMonth()+1&&a===currentSelectedDate.getFullYear()&&d.classList.add("selected"),o||d.addEventListener("click",()=>{updateMainCalendar(new Date(a,n-1,t)),renderMonthView(currentViewMonth,currentViewYear)}),e.appendChild(d)}document.addEventListener("DOMContentLoaded",function(){const e=new Date;initLunarInputs(),updateMainCalendar(e);const t=document.getElementById("input-mode-toggle");t&&t.addEventListener("click",toggleInputMode);const n=document.getElementById("solar-date-input");n&&(n.addEventListener("change",handleDateConversion),n.addEventListener("input",handleDateConversion));[document.getElementById("lunar-day-input"),document.getElementById("lunar-month-input"),document.getElementById("lunar-year-input"),document.getElementById("lunar-leap-input")].forEach(e=>{e&&(e.addEventListener("change",handleLunarConversion),"INPUT"===e.tagName&&e.addEventListener("input",handleLunarConversion))});const a=document.getElementById("prev-day-btn"),o=document.getElementById("next-day-btn");a&&a.addEventListener("click",goToPrevDay),o&&o.addEventListener("click",goToNextDay),renderMonthView(e.getMonth()+1,e.getFullYear());const r=document.getElementById("prev-month-btn"),d=document.getElementById("next-month-btn"),u=document.getElementById("today-btn");r&&r.addEventListener("click",()=>{currentViewMonth--,currentViewMonth<1&&(currentViewMonth=12,currentViewYear--),renderMonthView(currentViewMonth,currentViewYear)}),d&&d.addEventListener("click",()=>{currentViewMonth++,currentViewMonth>12&&(currentViewMonth=1,currentViewYear++),renderMonthView(currentViewMonth,currentViewYear)}),u&&u.addEventListener("click",()=>{const e=new Date;currentViewMonth=e.getMonth()+1,currentViewYear=e.getFullYear(),renderMonthView(currentViewMonth,currentViewYear)})});