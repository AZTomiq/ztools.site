const TAX_RATES={general:.2,small:.2,"oil-gas-min":.32,"oil-gas-max":.5,"rare-resources":.4},SIMPLE_RATES={goods:.01,services:.05,other:.02},methodRadios=document.querySelectorAll('input[name="calculation-method"]'),detailedForm=document.getElementById("detailed-form"),simpleForm=document.getElementById("simple-form"),resultSection=document.getElementById("result-section"),detailedResults=document.getElementById("detailed-results"),simpleResults=document.getElementById("simple-results"),revenueInput=document.getElementById("revenue"),expensesInput=document.getElementById("deductible-expenses"),otherIncomeInput=document.getElementById("other-income"),exemptIncomeInput=document.getElementById("exempt-income"),previousLossesInput=document.getElementById("previous-losses"),businessTypeSelect=document.getElementById("business-type"),rdFundInput=document.getElementById("rd-fund"),simpleRevenueInput=document.getElementById("simple-revenue"),businessSectorSelect=document.getElementById("business-sector"),btnCalculateDetailed=document.getElementById("btn-calculate-detailed"),btnResetDetailed=document.getElementById("btn-reset-detailed"),btnCalculateSimple=document.getElementById("btn-calculate-simple"),btnResetSimple=document.getElementById("btn-reset-simple");function parseNumber(e){return e&&parseFloat(e.toString().replace(/[^\d.-]/g,""))||0}function formatCurrency(e){if(0===e)return"0 đ";return(e<0?"-":"")+Math.abs(e).toLocaleString("vi-VN")+" đ"}function formatPercent(e){return(100*e).toFixed(1)+"%"}function formatNumberInput(e){e.addEventListener("input",function(e){let t=e.target.value.replace(/[^\d]/g,"");t&&(e.target.value=parseInt(t).toLocaleString("vi-VN"))}),e.addEventListener("blur",function(e){e.target.value||(e.target.value="0")})}function calculateDetailedTax(){const e=parseNumber(revenueInput.value),t=parseNumber(expensesInput.value),n=parseNumber(otherIncomeInput.value),l=parseNumber(exemptIncomeInput.value),s=parseNumber(previousLossesInput.value),u=businessTypeSelect.value,o=parseFloat(rdFundInput.value)/100;if(0===e)return alert("Vui lòng nhập doanh thu!"),void revenueInput.focus();const r=e-t+n;let a=r-l-s;a<0&&(a=0);let m=0;o>0&&a>0&&(m=a*Math.min(o,.1));let c=TAX_RATES.general;"small"===u?c=TAX_RATES.small:"oil-gas"===u?c=TAX_RATES["oil-gas-min"]:"rare-resources"===u&&(c=TAX_RATES["rare-resources"]);displayDetailedResults({revenue:e,expenses:t,otherIncome:n,taxableIncome:r,exemptIncome:l,previousLosses:s,rdFund:m,incomeForTax:a,taxRate:c,totalTax:(a-m)*c})}function displayDetailedResults(e){document.getElementById("result-revenue").textContent=formatCurrency(e.revenue),document.getElementById("result-expenses").textContent=formatCurrency(e.expenses),document.getElementById("result-other-income").textContent=formatCurrency(e.otherIncome),document.getElementById("result-taxable-income").textContent=formatCurrency(e.taxableIncome),document.getElementById("result-exempt").textContent=formatCurrency(e.exemptIncome),document.getElementById("result-losses").textContent=formatCurrency(e.previousLosses),document.getElementById("result-rd-fund").textContent=formatCurrency(e.rdFund),document.getElementById("result-income-for-tax").textContent=formatCurrency(e.incomeForTax),document.getElementById("result-tax-rate").textContent=formatPercent(e.taxRate),document.getElementById("result-total-tax").textContent=formatCurrency(e.totalTax),detailedResults.style.display="block",simpleResults.style.display="none",resultSection.classList.add("show"),resultSection.scrollIntoView({behavior:"smooth",block:"nearest"})}function calculateSimpleTax(){const e=parseNumber(simpleRevenueInput.value),t=businessSectorSelect.value;if(0===e)return alert("Vui lòng nhập doanh thu!"),void simpleRevenueInput.focus();const n=SIMPLE_RATES[t];displaySimpleResults({revenue:e,rate:n,totalTax:e*n})}function displaySimpleResults(e){document.getElementById("simple-result-revenue").textContent=formatCurrency(e.revenue),document.getElementById("simple-result-rate").textContent=formatPercent(e.rate),document.getElementById("simple-result-total").textContent=formatCurrency(e.totalTax),detailedResults.style.display="none",simpleResults.style.display="block",resultSection.classList.add("show"),resultSection.scrollIntoView({behavior:"smooth",block:"nearest"})}function resetDetailedForm(){revenueInput.value="",expensesInput.value="",otherIncomeInput.value="",exemptIncomeInput.value="",previousLossesInput.value="",businessTypeSelect.value="general",rdFundInput.value="0",resultSection.classList.remove("show")}function resetSimpleForm(){simpleRevenueInput.value="",businessSectorSelect.value="goods",resultSection.classList.remove("show")}[revenueInput,expensesInput,otherIncomeInput,exemptIncomeInput,previousLossesInput,simpleRevenueInput].forEach(formatNumberInput),methodRadios.forEach(e=>{e.addEventListener("change",function(){"detailed"===this.value?(detailedForm.style.display="block",simpleForm.style.display="none",resultSection.classList.remove("show")):(detailedForm.style.display="none",simpleForm.style.display="block",resultSection.classList.remove("show"))})}),btnCalculateDetailed.addEventListener("click",calculateDetailedTax),btnResetDetailed.addEventListener("click",resetDetailedForm),btnCalculateSimple.addEventListener("click",calculateSimpleTax),btnResetSimple.addEventListener("click",resetSimpleForm),detailedForm.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),calculateDetailedTax())}),simpleForm.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),calculateSimpleTax())});