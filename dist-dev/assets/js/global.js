document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("theme-toggle"),t=document.documentElement,o=t=>{e.textContent="dark"===t?"‚òÄÔ∏è":"üåô"};o(t.getAttribute("data-theme")),e.addEventListener("click",()=>{const e="dark"===t.getAttribute("data-theme")?"light":"dark";t.setAttribute("data-theme",e),localStorage.setItem("theme",e),o(e)}),console.log("ZTools Global JS Loaded"),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>console.log("SW Registered!",e.scope)).catch(e=>console.error("SW Registration Failed",e))});document.querySelectorAll(".nav-item").forEach(e=>{const t=e.querySelector(".dropdown-toggle"),o=e.querySelector(".dropdown-menu");t&&o&&t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),document.querySelectorAll(".dropdown-menu.show").forEach(e=>{e!==o&&e.classList.remove("show")}),o.classList.toggle("show"),t.setAttribute("aria-expanded",o.classList.contains("show"))})}),document.querySelectorAll(".mega-header").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),t.preventDefault();const o="true"===e.getAttribute("aria-expanded");e.setAttribute("aria-expanded",!o)})}),document.addEventListener("click",e=>{e.target.closest(".nav-item")||document.querySelectorAll(".dropdown-menu.show").forEach(e=>{e.classList.remove("show");const t=e.parentElement.querySelector(".dropdown-toggle");t&&t.setAttribute("aria-expanded","false")})});const s=document.getElementById("search-btn"),n=document.getElementById("search-modal"),r=document.getElementById("search-input"),l=document.getElementById("search-results"),a=document.getElementById("close-search"),c=document.querySelector(".search-overlay");let d=[];try{const e=document.getElementById("tools-data");e&&(d=JSON.parse(e.textContent))}catch(e){console.error("Error loading search data",e)}const i=()=>{n.classList.add("show"),document.body.style.overflow="hidden",setTimeout(()=>r.focus(),50),m("")},u=()=>{n.classList.remove("show"),document.body.style.overflow="",r.value=""};function m(e){if(!l)return;const t=e.toLowerCase(),o=d.filter(e=>!t||(e.title.toLowerCase().includes(t)||e.desc.toLowerCase().includes(t)||e.id.toLowerCase().includes(t))).slice(0,10);if(0===o.length){const t="vi"===document.documentElement.lang?"Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho":"No results for";return void(l.innerHTML=`<div class="search-no-results">${t} "${e}"</div>`)}l.innerHTML=o.map((e,t)=>`\n      <a href="${e.link}" class="search-result-item ${0===t?"selected":""}" data-index="${t}">\n        <div class="result-icon">${e.icon}</div>\n        <div class="result-info">\n          <span class="result-title">${e.title}</span>\n          <span class="result-desc">${e.desc}</span>\n        </div>\n        <span class="result-cat">${e.category}</span>\n      </a>\n    `).join(""),function(){let e=0;const t=l.querySelectorAll(".search-result-item");r.onkeydown=o=>{if("ArrowDown"===o.key)o.preventDefault(),t[e].classList.remove("selected"),e=(e+1)%t.length,t[e].classList.add("selected"),t[e].scrollIntoView({block:"nearest"});else if("ArrowUp"===o.key)o.preventDefault(),t[e].classList.remove("selected"),e=(e-1+t.length)%t.length,t[e].classList.add("selected"),t[e].scrollIntoView({block:"nearest"});else if("Enter"===o.key){o.preventDefault();const e=l.querySelector(".search-result-item.selected");e&&e.click()}}}()}s&&s.addEventListener("click",i),a&&a.addEventListener("click",u),c&&c.addEventListener("click",u),document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"k"===e.key&&(e.preventDefault(),i()),"Escape"===e.key&&u()}),r.addEventListener("input",e=>{m(e.target.value.trim())}),document.querySelectorAll(".tool-item, .mega-link, .search-result-item").forEach(e=>{e.addEventListener("click",t=>{!function(e){if(!e)return;try{const t=e.split("/").filter(Boolean),o=t[t.length-1],s=Date.now();let n=JSON.parse(localStorage.getItem("ztools_recent")||"{}");n[o]=s,localStorage.setItem("ztools_recent",JSON.stringify(n));let r=JSON.parse(localStorage.getItem("ztools_usage")||"{}");r[o]=(r[o]||0)+1,localStorage.setItem("ztools_usage",JSON.stringify(r))}catch(e){console.error("Tracking error",e)}}(e.getAttribute("href")),e.classList.contains("mega-link")&&document.querySelectorAll(".dropdown-menu.show").forEach(e=>{e.classList.remove("show");const t=e.parentElement.querySelector(".dropdown-toggle");t&&t.setAttribute("aria-expanded","false")})})})});